<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Libris Boksökning - Region Örebro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="max-w-6xl mx-auto p-6">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="flex items-center justify-center gap-3 mb-2">
                <svg class="w-10 h-10 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
                <h1 class="text-4xl font-bold text-gray-800">Libris Boksökning</h1>
            </div>
            <p class="text-gray-600">Sök i Sveriges nationella bibliotekskatalog - Region Örebro</p>
        </div>

        <!-- Search Box -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex gap-2 mb-4">
                <div class="flex-1 relative">
                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input
                        type="text"
                        id="searchInput"
                        placeholder="Sök efter titel, författare eller ISBN..."
                        class="w-full pl-10 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none text-lg"
                    />
                </div>
                <button
                    id="filterBtn"
                    class="px-4 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
                >
                    Filter
                </button>
                <button
                    id="searchBtn"
                    class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold transition-colors"
                >
                    Sök
                </button>
            </div>

            <!-- Filters -->
            <div id="filters" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 pt-4 border-t">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Författare</label>
                    <input type="text" id="authorFilter" placeholder="Efternamn" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Språk</label>
                    <select id="languageFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                        <option value="">Alla språk</option>
                        <option value="swe">Svenska</option>
                        <option value="eng">Engelska</option>
                        <option value="nor">Norska</option>
                        <option value="dan">Danska</option>
                        <option value="ger">Tyska</option>
                        <option value="fre">Franska</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Utgivningsår</label>
                    <input type="text" id="yearFilter" placeholder="t.ex. 2023" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Materialtyp</label>
                    <select id="typeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                        <option value="">Alla typer</option>
                        <option value="Text">Bok</option>
                        <option value="Audio">Ljudbok</option>
                        <option value="Electronic">E-bok</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Loading & Error -->
        <div id="loading" class="hidden text-center py-8">
            <svg class="animate-spin w-8 h-8 mx-auto text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
            </svg>
            <p class="mt-2 text-gray-600">Söker...</p>
        </div>

        <div id="error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4"></div>

        <!-- Results -->
        <div id="results"></div>

        <!-- Info -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-5">
            <h3 class="font-bold text-gray-800 mb-2">Om tjänsten</h3>
            <p class="text-gray-600 text-sm mb-2">
                Denna tjänst söker i Libris och visar om böcker finns tillgängliga på bibliotek i Region Örebro.
            </p>
            <p class="text-gray-600 text-sm">
                <span class="font-semibold">Bibliotek som ingår:</span> Örebro stadsbibliotek, Hallsbergs bibliotek, Kumla bibliotek, Lindesbergs stadsbibliotek, Ljusnarsbergs bibliotek, Nora stadsbibliotek, Askersunds bibliotek, Karlskoga bibliotek, Degerfors bibliotek, Hällefors bibliotek, Laxå bibliotek, Lekebergs bibliotek
            </p>
        </div>
    </div>

    <script>
        const orebroLibraries = [
            { sigel: 'Ore', name: 'Örebro stadsbibliotek' },
            { sigel: 'Hal', name: 'Hallsbergs bibliotek' },
            { sigel: 'Kum', name: 'Kumla bibliotek' },
            { sigel: 'Lin', name: 'Lindesbergs stadsbibliotek' },
            { sigel: 'Lja', name: 'Ljusnarsbergs bibliotek' },
            { sigel: 'Ner', name: 'Nora stadsbibliotek' },
            { sigel: 'Ask', name: 'Askersunds bibliotek' },
            { sigel: 'Kar', name: 'Karlskoga bibliotek' },
            { sigel: 'Deg', name: 'Degerfors bibliotek' },
            { sigel: 'Hjo', name: 'Hällefors bibliotek' },
            { sigel: 'Lax', name: 'Laxå bibliotek' },
            { sigel: 'Leka', name: 'Lekebergs bibliotek' }
        ];

        document.getElementById('filterBtn').addEventListener('click', () => {
            const filters = document.getElementById('filters');
            filters.classList.toggle('hidden');
        });

        document.getElementById('searchBtn').addEventListener('click', search);
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') search();
        });

        async function search() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const results = document.getElementById('results');

            loading.classList.remove('hidden');
            error.classList.add('hidden');
            results.innerHTML = '';

            try {
                let searchQuery = query;
                const author = document.getElementById('authorFilter').value;
                const language = document.getElementById('languageFilter').value;
                const year = document.getElementById('yearFilter').value;
                const type = document.getElementById('typeFilter').value;

                if (author) searchQuery += ` ${author}`;
                if (language) searchQuery += ` language:${language}`;
                if (year) searchQuery += ` year:${year}`;
                if (type) searchQuery += ` @type:${type}`;

                const response = await fetch(`https://libris.kb.se/find.json?q=${encodeURIComponent(searchQuery)}&_limit=30`);
                const data = await response.json();
                const books = data.items || [];

                if (books.length === 0) {
                    error.textContent = 'Inga resultat hittades';
                    error.classList.remove('hidden');
                    return;
                }

                const booksWithHoldings = await Promise.all(
                    books.map(async (book) => {
                        if (book['@id']) {
                            try {
                                const holdingsResponse = await fetch(`https://libris.kb.se${book['@id']}/data.json`);
                                const holdingsData = await holdingsResponse.json();
                                return { ...book, fullData: holdingsData };
                            } catch {
                                return book;
                            }
                        }
                        return book;
                    })
                );

                displayResults(booksWithHoldings);

            } catch (err) {
                error.textContent = 'Ett fel uppstod vid sökning: ' + err.message;
                error.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
            }
        }

        function displayResults(books) {
            const results = document.getElementById('results');
            results.innerHTML = `<p class="text-gray-700 font-semibold text-lg mb-4">Hittade ${books.length} resultat</p>`;

            books.forEach((book, index) => {
                const title = book.hasTitle?.[0]?.mainTitle || 'Titel saknas';
                const authors = getAuthors(book);
                const year = book.publication?.[0]?.year || book.instanceOf?.publication?.[0]?.year || '';
                const isbn = getISBN(book);
                const language = getLanguage(book);
                const edition = book.editionStatement || book.fullData?.['@graph']?.[0]?.editionStatement || '';
                const orebroHoldings = checkOrebroHoldings(book);
                const librisUrl = book['@id'] ? `https://libris.kb.se${book['@id']}` : '';

                const bookDiv = document.createElement('div');
                bookDiv.className = 'bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow p-5 mb-4';
                bookDiv.innerHTML = `
                    <div class="flex justify-between items-start gap-4">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-gray-800 mb-2">${title}</h3>
                            <p class="text-gray-600 mb-1"><span class="font-semibold">Författare:</span> ${authors}</p>
                            ${year ? `<p class="text-gray-600 mb-1"><span class="font-semibold">År:</span> ${year}</p>` : ''}
                            ${edition ? `<p class="text-gray-600 mb-1"><span class="font-semibold">Utgåva:</span> ${edition}</p>` : ''}
                            ${language ? `<p class="text-gray-600 mb-1"><span class="font-semibold">Språk:</span> ${language}</p>` : ''}
                            ${isbn ? `<p class="text-gray-600 mb-1"><span class="font-semibold">ISBN:</span> ${isbn}</p>` : ''}
                            
                            ${orebroHoldings.length > 0 ? `
                                <div class="mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                                    <div class="flex items-center gap-2 mb-2">
                                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path>
                                            <circle cx="12" cy="10" r="3"></circle>
                                        </svg>
                                        <span class="font-semibold text-green-800">Finns i Region Örebro (${orebroHoldings.length} bibliotek)</span>
                                    </div>
                                    <button onclick="toggleHoldings('holdings-${index}')" class="text-green-700 hover:text-green-900 font-semibold text-sm">
                                        Visa bibliotek
                                    </button>
                                    <div id="holdings-${index}" class="hidden mt-4 pt-4 border-t space-y-2">
                                        ${orebroHoldings.map(h => `
                                            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                                <span class="font-medium text-gray-700">${h.library}</span>
                                                <span class="text-sm text-gray-600">${h.shelfMark}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : `
                                <div class="mt-3 p-3 bg-gray-50 border border-gray-200 rounded-lg">
                                    <p class="text-gray-600 text-sm">Finns inte i Region Örebros bibliotek för tillfället</p>
                                </div>
                            `}
                        </div>
                        ${librisUrl ? `
                            <a href="${librisUrl}" target="_blank" rel="noopener noreferrer" 
                               class="flex items-center gap-1 text-indigo-600 hover:text-indigo-800 font-semibold whitespace-nowrap">
                                Visa i Libris
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15 3 21 3 21 9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                            </a>
                        ` : ''}
                    </div>
                `;
                results.appendChild(bookDiv);
            });
        }

        function toggleHoldings(id) {
            const elem = document.getElementById(id);
            elem.classList.toggle('hidden');
        }

        function getAuthors(book) {
            const contribs = book.instanceOf?.contribution || [];
            const authors = contribs.map(c => c.agent?.familyName || c.agent?.name).filter(Boolean).join(', ');
            return authors || 'Okänd författare';
        }

        function getISBN(book) {
            const identifiers = book.identifiedBy || [];
            const isbn = identifiers.find(id => id['@type'] === 'ISBN');
            return isbn?.value || '';
        }

        function getLanguage(book) {
            const languages = book.instanceOf?.language || [];
            const langMap = {
                'https://id.kb.se/language/swe': 'Svenska',
                'https://id.kb.se/language/eng': 'Engelska',
                'https://id.kb.se/language/nor': 'Norska',
                'https://id.kb.se/language/dan': 'Danska',
                'https://id.kb.se/language/ger': 'Tyska',
                'https://id.kb.se/language/fre': 'Franska'
            };
            return languages.map(lang => {
                if (typeof lang === 'string') {
                    return langMap[lang] || lang.split('/').pop();
                }
                return langMap[lang['@id']] || 'Okänt språk';
            }).join(', ');
        }

        function checkOrebroHoldings(book) {
            if (!book.fullData || !book.fullData['@graph']) return [];
            
            const holdings = book.fullData['@graph'].filter(item => 
                item['@type'] === 'Item' && item.heldBy
            );
            
            const orebroHoldings = holdings.filter(holding => {
                const heldBy = holding.heldBy?.['@id'] || '';
                return orebroLibraries.some(lib => heldBy.includes(`/library/${lib.sigel}`));
            });

            return orebroHoldings.map(holding => {
                const sigelMatch = holding.heldBy?.['@id']?.match(/\/library\/([^/]+)/);
                const sigel = sigelMatch ? sigelMatch[1] : '';
                const library = orebroLibraries.find(lib => lib.sigel === sigel);
                
                return {
                    library: library?.name || sigel,
                    shelfMark: holding.shelfMark || holding.shelfLabel || 'Hyllplacering saknas'
                };
            });
        }
    </script>
</body>
</html>
